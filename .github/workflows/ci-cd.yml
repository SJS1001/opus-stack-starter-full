name: ci-cd
on:
  push: { branches: [ main ] }
  pull_request: { branches: [ main ] }
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions: { contents: read, packages: write }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '9.0.x' }
      - name: Restore
        run: dotnet restore ./src
      - name: Build
        run: dotnet build ./src --configuration Release --no-restore
      - name: Publish and Dockerize
        run: |
          for svc in gateway customer telemetry workflow files; do
            dotnet publish ./src/services/$svc/**/*.csproj -c Release -o out/$svc
            docker build -t ghcr.io/${{ github.repository }}/$svc:${{ github.sha }} out/$svc
            echo $CR_PAT | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker push ghcr.io/${{ github.repository }}/$svc:${{ github.sha }}
          done
